{% extends "classifieds/base.html" %}
{% load i18n %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card border-0 shadow-sm">
                <div class="card-header text-white" style="background: linear-gradient(180deg, #131921 0%, #232f3e 100%); border-bottom: 3px solid #febd69;">
                    <h2 class="mb-0 h5"><i class="bi bi-currency-bitcoin me-2"></i>{% trans "Pay with Crypto" %}</h2>
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-light border mb-4" style="background-color: #f8f9fa;">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle text-primary me-2 mt-1"></i>
                            <div>
                                <p class="mb-1 small"><strong>{% trans "You are subscribing to:" %}</strong> {{ plan.name }}</p>
                                <p class="mb-0 small"><strong>{% trans "Price:" %}</strong> <span class="text-success fw-bold">{{ plan.price }} {{ plan.currency }}</span></p>
                            </div>
                        </div>
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>{{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" action="{% url 'subscriptions:create_crypto_invoice' %}">
                        {% csrf_token %}
                        <input type="hidden" name="plan_id" value="{{ plan.id }}">

                        <div class="mb-4">
                            <label class="form-label fw-semibold" for="currency">
                                <i class="bi bi-wallet2 me-1"></i>{% trans "Select Currency" %}
                            </label>
                            {% if currencies|length > 1 %}
                                <div class="d-flex align-items-center mb-2">
                                    <div id="currency-preview" class="d-flex align-items-center">
                                        <!-- Preview populated by JS -->
                                    </div>
                                </div>

                                <!-- Custom dropdown button -->
                                <div class="custom-dropdown mb-2" style="position: relative;">
                                    <button type="button" class="form-select form-select-lg" id="currency-dropdown-toggle" style="border-color: #ddd; text-align: left; background-color: #fff; border-radius: 0.375rem; padding: 0.75rem 0.875rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer;">
                                        <span>{% trans "Choose a currency..." %}</span>
                                        <i class="bi bi-chevron-down" style="font-size: 0.9rem;"></i>
                                    </button>

                                    <!-- Dropdown menu with currency options -->
                                    <div id="currency-dropdown-menu" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 0.375rem 0.375rem; max-height: 300px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                        {% for currency in currencies %}
                                            {% if currency.name %}
                                                <div class="currency-option" data-value="{{ currency.code }}" data-name="{{ currency.name }}" data-network="{{ currency.network }}" data-logo="{% if currency.logo_url %}{{ currency.logo_url }}{% endif %}" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 10px; transition: background-color 0.2s;">
                                                    <div style="width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border-radius: 6px; overflow: hidden;">
                                                        {% if currency.logo_url %}
                                                            <img src="{{ currency.logo_url }}" alt="{{ currency.name }}" style="width: 28px; height: 28px; object-fit: contain;">
                                                        {% else %}
                                                            <i class="bi bi-wallet2" style="font-size: 18px; color: #999;"></i>
                                                        {% endif %}
                                                    </div>
                                                    <div style="flex: 1; min-width: 0;">
                                                        <div style="font-weight: 600; font-size: 0.95rem;">{{ currency.code|upper }}{% if currency.network %} <span style="display: inline-block; background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; font-weight: 500; margin-left: 4px;">{{ currency.network|upper }}</span>{% endif %}</div>
                                                        <div style="font-size: 0.85rem; color: #6c757d; margin-top: 2px;">{{ currency.name }}</div>
                                                    </div>
                                                </div>
                                            {% else %}
                                                <div class="currency-option" data-value="{{ currency }}" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;">
                                                    {{ currency|upper }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Hidden select for form submission -->
                                <input type="hidden" name="currency" id="currency" value="">

                                <small class="form-text text-muted">{% trans "Select your preferred cryptocurrency" %}</small>
                            {% elif currencies|length == 1 %}
                                {# Single option: show as read-only and submit hidden value #}
                                {% if currencies.0.name %}
                                    <input type="hidden" name="currency" id="currency" value="{{ currencies.0.code }}">
                                    <div class="form-control form-control-lg d-flex align-items-center" style="background:#fff;border:1px solid #ddd;">
                                        {% if currencies.0.logo_url %}
                                            <img src="{{ currencies.0.logo_url }}" alt="{{ currencies.0.name }}" style="width:28px;height:28px;object-fit:contain;margin-right:8px;">
                                        {% endif %}
                                        <div>
                                            <strong>{{ currencies.0.name }}</strong>
                                            <div class="small text-muted">{{ currencies.0.code|upper }}{% if currencies.0.network %} • {{ currencies.0.network|upper }}{% endif %} • {% trans "Auto-selected" %}</div>
                                        </div>
                                    </div>
                                {% else %}
                                    <input type="hidden" name="currency" id="currency" value="{{ currencies.0 }}">
                                    <div class="form-control form-control-lg d-flex align-items-center" style="background:#fff;border:1px solid #ddd;">
                                        <strong>{{ currencies.0|upper }}</strong>
                                        <small class="text-muted ms-2">{% trans "Auto-selected" %}</small>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-warning">{% trans "No supported tokens available right now." %}</div>
                            {% endif %}
                        </div>

                        <div id="estimate-container" class="d-none mb-4">
                            <div class="card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid #febd69;">
                                <div class="card-body p-3">
                                    <p class="small text-muted mb-2"><i class="bi bi-calculator me-1"></i>{% trans "Estimated Amount:" %}</p>
                                    <p class="h4 mb-2 text-dark" id="estimated-amount">--</p>
                                    <hr class="my-2" style="opacity: 0.3;">
                                    <p class="small text-muted mb-0">
                                        <i class="bi bi-arrow-down-circle me-1"></i>{% trans "Minimum:" %} <span class="fw-semibold" id="min-amount">--</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-lg w-100 text-white fw-semibold shadow-sm" style="background: linear-gradient(135deg, #febd69 0%, #f3a847 100%); border: none; color: #131921 !important;">
                            <i class="bi bi-lock-fill me-2"></i>{% trans "Pay Now" %}
                        </button>

                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>{% trans "Secure cryptocurrency payment" %}
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const currencyInput = document.getElementById('currency');
    const estimateContainer = document.getElementById('estimate-container');
    const estimatedAmountEl = document.getElementById('estimated-amount');
    const minAmountEl = document.getElementById('min-amount');

    // Custom dropdown handling
    const dropdownToggle = document.getElementById('currency-dropdown-toggle');
    const dropdownMenu = document.getElementById('currency-dropdown-menu');
    const currencyOptions = document.querySelectorAll('.currency-option');

    if (dropdownToggle && dropdownMenu) {
        // Toggle dropdown visibility
        dropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            dropdownMenu.style.display = dropdownMenu.style.display === 'none' ? 'block' : 'none';
        });

        // Handle currency option selection
        currencyOptions.forEach(option => {
            option.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const name = this.getAttribute('data-name');
                const network = this.getAttribute('data-network');
                const logo = this.getAttribute('data-logo');

                // Set hidden input value
                currencyInput.value = value;

                // Update toggle button text
                updateToggleButton(value, name, network, logo);

                // Update preview
                updatePreview({value, name, network, logo});

                // Close dropdown
                dropdownMenu.style.display = 'none';

                // Fetch estimate
                if (value) {
                    fetchEstimateFor(value);
                }
            });

            // Hover effect
            option.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });
            option.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                dropdownMenu.style.display = 'none';
            }
        });
    }

    function updateToggleButton(code, name, network, logo) {
        const content = dropdownToggle.querySelector('span') || dropdownToggle.children[0];
        const codeEl = document.createElement('span');
        codeEl.style.fontWeight = '600';
        codeEl.textContent = (code || '').toUpperCase();

        let buttonHTML = `<div style="display: flex; align-items: center; gap: 8px; flex: 1;">`;
        if (logo) {
            buttonHTML += `<img src="${logo}" alt="${name}" style="width: 24px; height: 24px; object-fit: contain;">`;
        } else {
            buttonHTML += `<i class="bi bi-wallet2" style="font-size: 18px; color: #999;"></i>`;
        }
        buttonHTML += `<div><div style="font-weight: 600;">${(code || '').toUpperCase()}`;
        if (network) {
            buttonHTML += ` <span style="display: inline-block; background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; margin-left: 4px;">${network.toUpperCase()}</span>`;
        }
        buttonHTML += `</div><div style="font-size: 0.85rem; color: #6c757d;">${name}</div></div></div>`;

        dropdownToggle.innerHTML = buttonHTML + '<i class="bi bi-chevron-down" style="font-size: 0.9rem;"></i>';
    }

    function updatePreview(data) {
        const preview = document.getElementById('currency-preview');
        preview.innerHTML = '';

        const {value, name, network, logo} = data;
        if (!value) return;

        const wrapper = document.createElement('div');
        wrapper.className = 'd-flex align-items-center gap-2';
        wrapper.style.padding = '6px 0';

        const iconWrapper = document.createElement('div');
        iconWrapper.style.width = '44px';
        iconWrapper.style.height = '44px';
        iconWrapper.style.display = 'flex';
        iconWrapper.style.alignItems = 'center';
        iconWrapper.style.justifyContent = 'center';
        iconWrapper.style.borderRadius = '8px';
        iconWrapper.style.background = '#f8f9fa';
        iconWrapper.style.border = '1px solid #e0e0e0';
        iconWrapper.style.flexShrink = '0';
        iconWrapper.style.overflow = 'hidden';

        if (logo && logo.trim()) {
            const img = document.createElement('img');
            img.src = logo;
            img.alt = name;
            img.style.width = '36px';
            img.style.height = '36px';
            img.style.objectFit = 'contain';
            img.style.padding = '4px';
            img.onerror = function() {
                iconWrapper.innerHTML = '<i class="bi bi-currency-bitcoin" style="font-size: 24px; color: #999;"></i>';
            };
            iconWrapper.appendChild(img);
        } else {
            iconWrapper.innerHTML = '<i class="bi bi-wallet2" style="font-size: 24px; color: #999;"></i>';
        }
        wrapper.appendChild(iconWrapper);

        const txt = document.createElement('div');
        txt.className = 'ms-1';
        txt.style.flex = '1';

        const top = document.createElement('div');
        top.className = 'd-flex align-items-center';
        top.style.marginBottom = '2px';

        const codeEl = document.createElement('div');
        codeEl.className = 'fw-bold';
        codeEl.style.fontSize = '0.95rem';
        codeEl.textContent = (value || '').toString().toUpperCase();
        top.appendChild(codeEl);

        if (network) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-secondary ms-2';
            badge.style.fontSize = '0.65rem';
            badge.style.padding = '3px 6px';
            badge.textContent = network.toString().toUpperCase();
            top.appendChild(badge);
        }

        const bottom = document.createElement('div');
        bottom.className = 'small text-muted';
        bottom.style.fontSize = '0.85rem';
        bottom.textContent = name;

        txt.appendChild(top);
        txt.appendChild(bottom);
        wrapper.appendChild(txt);

        preview.appendChild(wrapper);
    }

    function fetchEstimateFor(currency) {
        if (!currency) return;
        estimatedAmountEl.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>' + '{% trans "Loading..." %}';
        minAmountEl.textContent = '...';
        estimateContainer.classList.remove('d-none');

        fetch(`{% url 'subscriptions:get_crypto_estimate' %}?plan_id={{ plan.id }}&currency=${currency}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    estimatedAmountEl.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>' + '{% trans "Error" %}' + '</span>';
                    minAmountEl.textContent = '--';
                    console.error(data.error);
                } else {
                    estimatedAmountEl.innerHTML = `<i class="bi bi-coin me-2"></i>${data.estimated_amount} ${data.currency.toUpperCase()}`;
                    minAmountEl.textContent = `${data.min_amount} ${data.currency.toUpperCase()}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                estimatedAmountEl.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>' + '{% trans "Error fetching estimate" %}' + '</span>';
                minAmountEl.textContent = '--';
            });
    }

    // If single currency is pre-selected, fetch estimate immediately
    if (currencyInput.value) {
        fetchEstimateFor(currencyInput.value);
    }
});
</script>
{% endblock %}
